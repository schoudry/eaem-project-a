name: Sync to Adobe Cloud Manager as Submodule

on:
  push:
    branches:
      - main

jobs:
  sync-submodule:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout eaem-project-a
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
      
      - name: Clone Adobe Cloud Manager Parent Repository
        env:
          ADOBE_GIT_USERNAME: ${{ secrets.ADOBE_GIT_USERNAME }}
          ADOBE_GIT_PASSWORD: ${{ secrets.ADOBE_GIT_PASSWORD }}
        run: |
          cd /tmp
          git clone https://${ADOBE_GIT_USERNAME}:${ADOBE_GIT_PASSWORD}@git.cloudmanager.adobe.com/acsaem/eaem-project-parent/ eaem-project-parent
          cd eaem-project-parent
          git submodule update --init --recursive
      
      - name: Update Submodule to Latest Commit
        run: |
          cd /tmp/eaem-project-parent
          
          # Get the latest commit hash from the current repo
          LATEST_COMMIT=$(git -C $GITHUB_WORKSPACE rev-parse HEAD)
          echo "Latest commit: $LATEST_COMMIT"
          
          # Update the submodule to point to the latest commit
          cd eaem-project-a
          git fetch origin main
          git checkout $LATEST_COMMIT
          cd ..
          
          # Check if there are changes
          if git diff --quiet HEAD eaem-project-a; then
            echo "No changes to submodule reference"
            exit 0
          fi
          
          # Commit the updated submodule reference
          git add eaem-project-a
          git commit -m "Update eaem-project-a submodule to $LATEST_COMMIT"
      
      - name: Push to Adobe Cloud Manager
        env:
          ADOBE_GIT_USERNAME: ${{ secrets.ADOBE_GIT_USERNAME }}
          ADOBE_GIT_PASSWORD: ${{ secrets.ADOBE_GIT_PASSWORD }}
        run: |
          cd /tmp/eaem-project-parent
          git push https://${ADOBE_GIT_USERNAME}:${ADOBE_GIT_PASSWORD}@git.cloudmanager.adobe.com/acsaem/eaem-project-parent/ main
